<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>Ø¬Ø¯ÙˆÙ„ Ø§Ø®ØªÛŒØ§Ø± Ù…Ø¹Ø§Ù…Ù„Ù‡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Tahoma, sans-serif;
      direction: rtl;
      background-color: #f4f6f8;
      padding: 20px;
      margin: 0;
    }

    #searchSection {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    input, select, button {
      padding: 6px 12px;
      font-size: 14px;
      font-family: inherit;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
    }

    th, td {
      padding: 10px 14px;
      border: 1px solid #ccc;
      text-align: center;
      font-size: 14px;
    }

    th {
      background-color: darkblue;
      color: white;
      cursor: pointer;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    td.positive { color: green; font-weight: bold; }
    td.negative { color: red; font-weight: bold; }
    td.zero    { color: #888; }

    .blink-green {
      background-color: #28a745 !important;
      color: white !important;
      font-weight: bold;
      animation: blink 1s linear infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    #rowCount {
      margin-right: auto;
      font-size: 15px;
      color: darkgreen;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s ease-out;
    }

    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      width: 300px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      animation: slideUp 0.4s ease-out;
    }

    .modal label {
      display: block;
      margin: 10px 0;
    }

    .close {
      float: left;
      font-size: 20px;
      cursor: pointer;
      color: red;
      margin-bottom: 10px;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
	
    .tooltip-box {
      position: relative;
      display: inline-block;
      cursor: help;
    }

    .tooltip-box .tooltip-text {
      visibility: hidden;
      opacity: 0;
      background-color: #333;
      color: #fff;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 6px;
      white-space: nowrap;
      position: absolute;
      z-index: 100;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      transition: opacity 0.3s;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }

    .tooltip-box:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    .blink-green {
      background-color: #28a745 !important;
      color: white !important;
      font-weight: bold;
      animation: blink 1s linear infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }	
  </style>
</head>
<body>

<div id="searchSection">
  <input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ÛŒØ§ Ù†Ù…Ø§Ø¯ Ù¾Ø§ÛŒÙ‡..." />
  <select id="baseSymbolSelect">
    <option value="">-- ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù…Ø§Ø¯ Ù¾Ø§ÛŒÙ‡ --</option>
  </select>

  <button onclick="clearFilter()">Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡</button>
  <button onclick="openModal()">ÙÛŒÙ„ØªØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡ ğŸ”</button>
  <span id="rowCount"></span>
</div>

<table>
  <thead><tr id="tableHeaders"></tr></thead>
  <tbody id="tableBody"></tbody>
</table>

<div id="advancedModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>ÙÛŒÙ„ØªØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡</h3>

    <label>Ø­Ø¯Ø§Ù‚Ù„ Ø³ÙˆØ¯ Ù…Ø§Ù‡Ø§Ù†Ù‡ (%):
      <input type="number" id="advMonthlyProfit" min="0" max="50" step="1" />
    </label>

    <label>Ø­Ø¯Ø§Ú©Ø«Ø± ÙØ§ØµÙ„Ù‡ ØªØ§ Ø§Ø¹Ù…Ø§Ù„ (%):
      <input type="number" id="advMaxDiff" min="0" max="20" step="0.1" />
    </label>

    <label>Ø­Ø¯Ø§Ù‚Ù„ Ø³ÙˆØ¯ Ø¢Ø±Ø¨ÛŒØªØ±Ø§Ú˜ (%):
      <input type="number" id="advArbitrageProfit" min="0" max="50" step="0.1" />
    </label>

    <button onclick="applyAdvancedFilter()">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ± âœ…</button>
  </div>
</div>

<script>
const apiUrl = 'https://cdn.tsetmc.com/api/Instrument/GetInstrumentOptionMarketWatch/0';
const titleMap = {
  lVal18AFC_C: 'Ù†Ø§Ù… Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯',
  lval30_UA: 'Ù†Ù…Ø§Ø¯ Ù¾Ø§ÛŒÙ‡',
  contractSize: 'Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯',
  strikePrice: 'Ù‚ÛŒÙ…Øª Ø§Ø¹Ù…Ø§Ù„',
  pDrCotVal_UA: 'Ù‚ÛŒÙ…Øª Ù†Ù…Ø§Ø¯ Ù¾Ø§ÛŒÙ‡',
  pDrCotVal_C: 'Ù¾Ø±Ù…ÛŒÙˆÙ…',
  positionType: 'ÙˆØ¶Ø¹ÛŒØª',
  remainedDay: 'Ø±ÙˆØ² Ù…Ø§Ù†Ø¯Ù‡',
  strategyProfit: 'Ø³ÙˆØ¯ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ',
  monthlyProfit: 'Ø³ÙˆØ¯ Ù…Ø§Ù‡Ø§Ù†Ù‡', 
  arbitrageProfit: 'Ø³ÙˆØ¯ Ø¢Ø±Ø¨ÛŒØªØ±Ø§Ú˜'
};

const finalKeys = Object.keys(titleMap);
let originalData = [];
let currentSort = { key: '', asc: true };
let showAll = false;

function openModal() {
  document.getElementById('advancedModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('advancedModal').style.display = 'none';
}

function applyAdvancedFilter() {
  const minProfit = parseFloat(document.getElementById('advMonthlyProfit').value);
  const maxDiff = parseFloat(document.getElementById('advMaxDiff').value);
  const minArbProfit = parseFloat(document.getElementById('advArbitrageProfit').value);
  showAll = false;

  renderTable(originalData.filter(item => {
    const sp = Number(item.strikePrice);
    const pu = Number(item.pDrCotVal_UA);
    const pc = Number(item.pDrCotVal_C);
    const rd = Number(item.remainedDay);
	const vol = Number(item.qTotTran5J_C);
    const cao = sp + pc;
    const denom = (pu * 1.005) - pc;

    if (vol <= 0 || pu <= 0 || pc < 0 || sp <= 0 || rd <= 0 || denom <= 0) return false;

    const strategy = 100 * ((sp / denom) - 1);
    const monthly = (strategy / rd) * 30;
    const arb = ((pu * 0.99 - cao) / cao) * 100;
    const diffRatio = Math.abs(sp - pu) / pu;

    if (!isNaN(minProfit) && monthly < minProfit) return false;
    if (!isNaN(maxDiff) && (sp > pu && diffRatio > maxDiff / 100)) return false;
    if (!isNaN(minArbProfit) && arb < minArbProfit) return false;

    return true;
  }));

  closeModal();
}

function clearFilter() {
  showAll = true;
  document.getElementById('searchInput').value = '';
  document.getElementById('baseSymbolSelect').value = '';
  document.getElementById('advMonthlyProfit').value = '';
  document.getElementById('advMaxDiff').value = '';
  document.getElementById('advArbitrageProfit').value = '';
    document.getElementById('tableHeaders').innerHTML = finalKeys.map(k => {
    const isActive = k === currentSort.key;
    const icon = isActive ? (currentSort.asc ? 'â†‘' : 'â†“') : '';
    return `<th onclick="sortBy('${k}')">${titleMap[k]}</th>`;
  }).join('');
  renderTable(originalData);
}

function updateTable() {
  fetch(apiUrl)
    .then(res => res.json())
    .then(data => {
      originalData = data.instrumentOptMarketWatch || [];
      populateBaseSymbolDropdown(originalData);
      renderTable();
      document.getElementById('tableHeaders').innerHTML = finalKeys.map(key => {
        const isActive = key === currentSort.key;
        const icon = isActive ? (currentSort.asc ? 'â†‘' : 'â†“') : '';
        return `<th onclick="sortBy('${key}')">${titleMap[key]} ${icon}</th>`;
      }).join('');
    })
    .catch(err => console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:', err));
}

function populateBaseSymbolDropdown(data) {
  const select = document.getElementById('baseSymbolSelect');
  const symbols = [...new Set(data.map(x => x.lval30_UA))].sort();
  select.innerHTML = '<option value="">-- ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù…Ø§Ø¯ Ù¾Ø§ÛŒÙ‡ --</option>';
  symbols.forEach(sym => {
    const op = document.createElement('option');
    op.value = sym;
    op.textContent = sym;
    select.appendChild(op);
  });
}

function renderTable(dataArray = originalData) {
  const query = document.getElementById('searchInput').value.trim().toLowerCase();
  const selectedSymbol = document.getElementById('baseSymbolSelect').value;

  let filtered = [...dataArray];

  if (query)
    filtered = filtered.filter(x =>
      (x.lVal18AFC_C || '').toLowerCase().includes(query) ||
      (x.lval30_UA || '').toLowerCase().includes(query)
    );

  if (selectedSymbol)
    filtered = filtered.filter(x => x.lval30_UA === selectedSymbol);

  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  filtered.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = finalKeys.map(key => {
      let val = item[key] ?? '';
      let style = '';
      let cellClass = '';

        if (key === 'pDrCotVal_UA') {
          const live = Number(item.pDrCotVal_UA);
          const close = Number(item.pClosing_UA);
          let icon = '', color = '', diff = '';
          if (!isNaN(live) && !isNaN(close)) {
            const delta = ((live - close) / close) * 100;
            diff = delta.toFixed(2) + '%';
			tooltip = `Ø§Ø®ØªÙ„Ø§Ù Ù†Ø³Ø¨Øª Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù†ÛŒ: ${diff}`;
            if (live > close) { icon = '&#129093;'; color = 'green'; font = '25px'; }
            else if (live < close) { icon = '&#129095;'; color = 'red'; font = '25px';}
            else { icon = '&#11044;'; color = '#888'; font = '20px';}
            return `<td><span class="tooltip-box">${live.toLocaleString()}<span class="tooltip-text">${tooltip}</span></span><span style="color:${color}; font-size:${font}">${icon}</span></td>`;
          }
        }

      if (key === 'positionType') {
        const sp = Number(item.strikePrice);
        const pu = Number(item.pDrCotVal_UA);
        if (sp > 0 && pu > 0) {
          const diff = ((sp - pu) / pu) * 100;
          const diffRounded = diff.toFixed(2);
          let label = '', style = '', tooltip = '';
          if (Math.abs(diff) <= 1.5) {
            label = 'ATM';
            style = 'background-color:#d9d9d9;color:#000;font-weight:bold;';
            tooltip = `Ø§Ø®ØªÙ„Ø§Ù ${diffRounded}% â€” Ø¨ÛŒâ€ŒØªÙØ§ÙˆØª`;
          } else if (diff > 1.5) {
            label = 'OTM';
            style = 'background-color:#f8d7da;color:#721c24;font-weight:bold;';
            tooltip = `Ø§Ø®ØªÙ„Ø§Ù ${diffRounded}% â€” Ø¯Ø± Ø²ÛŒØ§Ù†`;
          } else {
            label = 'ITM';
            style = 'background-color:#d4edda;color:#155724;font-weight:bold;';
            tooltip = `Ø§Ø®ØªÙ„Ø§Ù ${diffRounded}% â€” Ø¯Ø± Ø³ÙˆØ¯`;
          }
          return `<td style="${style}"><span class="tooltip-box">${label}<span class="tooltip-text">${tooltip}</span></span></td>`;
        } else {
          return `<td>â€”</td>`;
        }
      }

      if (key === 'monthlyProfit') {
        const sp = Number(item.strikePrice);
        const pu = Number(item.pDrCotVal_UA);
        const pc = Number(item.pDrCotVal_C);
        const rd = Number(item.remainedDay);
        const denom = (pu * 1.005) - pc;
        const strategy = 100 * ((sp / denom) - 1);
        const monthProfit = ((strategy / rd) * 30).toFixed(1);		
        if (sp > 0 && pu > 0 && pc >= 0 && rd > 30 && monthProfit > 0 && denom > 0) {

          const blink = parseFloat(monthProfit) >= 10 ? 'blink-green' : '';
          return `<td class="${blink}">${monthProfit}</td>`; 
        } else {
          return `<td>â€”</td>`;
        }
      }


      if (key === 'arbitrageProfit') {
        const pu = Number(item.pDrCotVal_UA);
        const pc = Number(item.pDrCotVal_C);
        const sp = Number(item.strikePrice);
        const cao = sp + pc;
		const arbitrage = (((pu * 0.99 - cao) / cao) * 100).toFixed(1);
		if (arbitrage > 1 ) {
        
		const blink = parseFloat(arbitrage) >= 3 ? 'blink-green' : '';
		return `<td class="${blink}">${arbitrage}</td>`;
		
		
        } else {
          return `<td>â€”</td>`;
        }
      }

      if (key === 'strategyProfit') {
        const sp = Number(item.strikePrice);
        const pu = Number(item.pDrCotVal_UA);
        const pc = Number(item.pDrCotVal_C);
        const rd = Number(item.remainedDay);
        const denom = (pu * 1.005) - pc;
        const strategyProfit = (100 * ((sp / denom) - 1)).toFixed(1);
        if (strategyProfit > 0) {
        const blink = parseFloat(strategyProfit) >= 100 ? 'blink-green' : '';    
          return `<td class="${blink}">${strategyProfit}</td>`; 
        } else {
          return `<td>â€”</td>`;
        }
      }



      if (!isNaN(val) && val !== '') {
        const num = Number(val);
        if (key !== 'contractSize') {
          cellClass = num > 0 ? 'positive' : num < 0 ? 'negative' : 'zero';
        }

        if (key === 'contractSize' && num !== 1000) {
          style += 'font-weight:bold;background-color:darkred;color:white;';
        }

        if (key === 'remainedDay') {
          if (num < 5) style += 'background-color:#f8d7da; color:#721c24; font-weight:bold;';
          else if (num <= 30) style += 'background-color:#ffe5b4; color:#7b3f00; font-weight:bold;';
          else if (num <= 60) style += 'background-color:#fff3cd; color:#856404;';
          else if (num <= 90) style += 'background-color:#d4edda; color:#155724;';
          else style += 'background-color:#cce5ff; color:#004085;';
        }
      }


      return `<td style="${style}" class="${cellClass}">${val}</td>`;
    }).join('');
    tbody.appendChild(row);
  });

  document.getElementById('rowCount').textContent = `ØªØ¹Ø¯Ø§Ø¯: ${filtered.length}`;
}

function sortBy(key) {
  if (!key) return;

  if (currentSort.key === key) {
    currentSort.asc = !currentSort.asc;
  } else {
    currentSort.key = key;
    currentSort.asc = true;
  }

  const enriched = originalData.map(item => {
    const clone = { ...item };

    const denomS = (Number(item.pDrCotVal_UA) * 1.005) - Number(item.pDrCotVal_C);
    clone.strategyProfit = (denomS > 0 && item.strikePrice)
      ? (100 * ((item.strikePrice / denomS) - 1)).toFixed(1)
      : null;

    const rd = Number(item.remainedDay);
    clone.monthlyProfit = (clone.strategyProfit && rd > 0)
      ? ((clone.strategyProfit / rd) * 30).toFixed(1)
      : null;

    const pu = Number(item.pDrCotVal_UA);
    const pc = Number(item.pDrCotVal_C);
    const sp = Number(item.strikePrice);
    const cao = sp + pc;
    clone.arbitrageProfit = (pu > 0 && pc >= 0 && cao > 0)
      ? (((pu * 0.99 - cao) / cao) * 100).toFixed(1)
      : null;

    return clone;
  });

  enriched.sort((a, b) => {
    const valA = parseFloat(a[key]);
    const valB = parseFloat(b[key]);
    if (!isNaN(valA) && !isNaN(valB))
      return currentSort.asc ? valA - valB : valB - valA;

    return currentSort.asc
      ? String(a[key] ?? '').localeCompare(String(b[key] ?? ''))
      : String(b[key] ?? '').localeCompare(String(a[key] ?? ''));
  });

  renderTable(enriched);
  document.getElementById('tableHeaders').innerHTML = finalKeys.map(k => {
    const isActive = k === currentSort.key;
    const icon = isActive ? (currentSort.asc ? 'â†‘' : 'â†“') : '';
    return `<th onclick="sortBy('${k}')">${titleMap[k]} ${icon}</th>`;
  }).join('');
}

document.getElementById('searchInput').addEventListener('input', () => {
  renderTable();
});
document.getElementById('baseSymbolSelect').addEventListener('change', () => {
  renderTable();
});

showAll = false;
updateTable();
setInterval(updateTable, 300000); // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø± Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡
</script>
</body>
</html>